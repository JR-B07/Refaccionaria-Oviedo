<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>REFACCIONARIA - Cierres de Caja</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary-red: #c41e3a;
            --dark-red: #8b1428;
            --light-bg: #f5f5f5;
            --white: #ffffff;
            --text-dark: #333333;
            --border-color: #d4a574;
            --header-bg: #e8e8e8;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--light-bg);
            color: var(--text-dark);
            min-height: 100vh;
        }

        .top-bar {
            background-color: var(--primary-red);
            color: var(--white);
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            position: fixed;
            top: 0;
            width: 100%;
            z-index: 1000;
        }

        .top-bar h1 {
            font-size: 20px;
            font-weight: bold;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-left: auto;
        }

        .user-info p {
            font-size: 14px;
        }

        .logout-btn {
            background-color: var(--dark-red);
            color: var(--white);
            border: none;
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 600;
            transition: background-color 0.3s;
        }

        .logout-btn:hover {
            background-color: #6a0f1f;
        }

        .sucursal-badge {
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: #fff;
            padding: 6px 12px;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .sucursal-badge::before {
            content: "üìç";
        }

        .back-btn {
            background-color: var(--primary-red);
            color: var(--white);
            border: 1px solid var(--primary-red);
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            margin-right: auto;
        }

        .back-btn:hover {
            background-color: var(--dark-red);
            border-color: var(--dark-red);
        }

        .main-content {
            margin-top: 70px;
            padding: 40px;
            max-width: 1400px;
            margin-left: auto;
            margin-right: auto;
        }

        .breadcrumb {
            margin-bottom: 30px;
            font-size: 14px;
            color: #666;
        }

        .breadcrumb strong {
            color: var(--text-dark);
        }

        h2 {
            font-size: 28px;
            color: var(--text-dark);
            margin-bottom: 30px;
            border-bottom: 3px solid var(--border-color);
            padding-bottom: 15px;
        }

        .filters-section {
            background-color: var(--white);
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 30px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        }

        .filters-container {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr 1fr auto;
            gap: 15px;
            align-items: flex-end;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
        }

        .filter-group label {
            font-size: 12px;
            font-weight: 600;
            margin-bottom: 5px;
            color: var(--text-dark);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .filter-group input,
        .filter-group select {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            font-family: inherit;
        }

        .filter-group input:focus,
        .filter-group select:focus {
            outline: none;
            border-color: var(--primary-red);
            box-shadow: 0 0 0 3px rgba(196, 30, 58, 0.1);
        }

        .date-range {
            display: grid;
            grid-template-columns: 1fr 20px 1fr;
            gap: 8px;
            align-items: center;
        }

        .date-range span {
            text-align: center;
            font-size: 12px;
            font-weight: 600;
            color: #999;
        }

        .search-btn {
            background-color: var(--primary-red);
            color: var(--white);
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            transition: background-color 0.3s;
        }

        .search-btn:hover {
            background-color: var(--dark-red);
        }

        .table-section {
            background-color: var(--white);
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        }

        .table-wrapper {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }

        thead {
            background-color: var(--header-bg);
            border-top: 2px solid #ccc;
            border-bottom: 2px solid #ccc;
        }

        th {
            padding: 12px 15px;
            text-align: left;
            font-weight: 700;
            color: var(--text-dark);
            text-transform: uppercase;
            font-size: 11px;
            letter-spacing: 0.5px;
            border-right: 1px solid #ddd;
        }

        th:last-child {
            border-right: none;
        }

        tbody tr {
            border-bottom: 1px solid #eee;
            transition: background-color 0.2s;
        }

        tbody tr:hover {
            background-color: #fafafa;
        }

        td {
            padding: 12px 15px;
            border-right: 1px solid #eee;
        }

        td:last-child {
            border-right: none;
        }

        /* Fila seleccionada */
        tbody tr.selected {
            background-color: #fff4f6;
            outline: 2px solid var(--primary-red);
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #999;
        }

        .empty-state p {
            font-size: 16px;
        }

        .sucursal-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 15px;
            background-color: var(--white);
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        }

        .sucursal-label {
            font-weight: 600;
            color: var(--text-dark);
            font-size: 14px;
        }

        .sucursal-selector {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }

        .sucursal-select-input {
            padding: 10px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            background-color: var(--white);
            font-weight: 600;
            min-width: 260px;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
        }

        .sucursal-select-input:focus {
            outline: none;
            border-color: var(--primary-red);
            box-shadow: 0 0 0 3px rgba(192, 57, 43, 0.12);
        }

        .sucursal-value {
            font-weight: bold;
            color: var(--primary-red);
            font-size: 16px;
        }

        @media (max-width: 1200px) {
            .filters-container {
                grid-template-columns: 1fr 1fr;
            }

            .search-btn {
                grid-column: 1 / -1;
            }
        }

        @media (max-width: 768px) {
            .main-content {
                padding: 20px;
            }

            h2 {
                font-size: 22px;
            }

            .filters-container {
                grid-template-columns: 1fr;
            }

            table {
                font-size: 12px;
            }

            th,
            td {
                padding: 8px 10px;
            }
        }

        .context-menu {
            position: fixed;
            background-color: var(--white);
            border: 1px solid #ddd;
            border-radius: 4px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            z-index: 2000;
            min-width: 220px;
            display: none;
        }

        .context-menu.show {
            display: block;
        }

        .context-menu-item {
            padding: 12px 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            color: var(--text-dark);
            transition: background-color 0.2s;
            border-bottom: 1px solid #f0f0f0;
            font-size: 14px;
        }

        .context-menu-item:last-child {
            border-bottom: none;
        }

        .context-menu-item:hover {
            background-color: var(--light-bg);
            color: var(--primary-red);
        }

        .context-menu-item.divider {
            padding: 0;
            height: 1px;
            background-color: #ddd;
            cursor: default;
        }

        .context-menu-item.divider:hover {
            background-color: #ddd;
            color: var(--text-dark);
        }

        .menu-button {
            background-color: var(--primary-red);
            color: var(--white);
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            transition: background-color 0.3s;
            margin-left: 10px;
        }

        .menu-button:hover {
            background-color: var(--dark-red);
        }

        .table-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            background-color: var(--white);
            border-top: 1px solid #eee;
            border-bottom: 1px solid #eee;
        }

        .table-info {
            font-size: 13px;
            color: #666;
        }

        .tabs-container {
            display: flex;
            gap: 0;
            margin-bottom: 20px;
            border-bottom: 2px solid #ddd;
        }

        .tab-button {
            background-color: #f5f5f5;
            color: var(--text-dark);
            border: none;
            padding: 12px 20px;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
            margin-bottom: -2px;
        }

        .tab-button:hover {
            background-color: #efefef;
        }

        .tab-button.active {
            background-color: var(--white);
            color: var(--primary-red);
            border-bottom-color: var(--primary-red);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }
    </style>
    <script src="componentes/selector-sucursal.js"></script>
    <script src="/static/js/sucursal_selector.js"></script>
</head>

<body>
    <div class="top-bar">
        <h1>REFACCIONARIA - ACCESO RAPIDO</h1>
        <div class="user-info">
            <span class="sucursal-badge" id="sucursalBadge">Sucursal</span>
            <p id="userDisplay">Usuario: Admin</p>
            <button class="logout-btn" onclick="logout()">Cerrar Sesi√≥n</button>
        </div>
    </div>

    <div class="main-content">
        <button class="back-btn" onclick="goBack()">‚Üê Volver</button>

        <div class="breadcrumb">
            <a onclick="goToCajas()"
                style="cursor:pointer; color: var(--primary-red); text-decoration: none; font-weight:700;">Cajas</a>
            &gt; <strong>Cierres de Caja</strong>
        </div>

        <h2>Lista de cierres de caja</h2>

        <div class="sucursal-info">
            <div class="sucursal-selector">
                <span class="sucursal-label">Sucursal:</span>
                <select id="sucursalSelect" class="sucursal-select-input"
                    onchange="cambiarSucursal(this.value)"></select>
            </div>
            <div>
                <button class="menu-button" onclick="window.location.href='/static/cierre_caja_nuevo.html'">‚ûï Nuevo
                    Cierre</button>
            </div>
        </div>

        <div class="filters-section">
            <div class="filters-container">
                <div class="filter-group">
                    <label for="cajaFilter">Caja</label>
                    <input type="text" id="cajaFilter" placeholder="Buscar caja...">
                </div>

                <div class="filter-group">
                    <label>Fechas de:</label>
                    <div class="date-range">
                        <input type="date" id="fechaInicio">
                        <span>a</span>
                        <input type="date" id="fechaFin">
                    </div>
                </div>

                <div class="filter-group">
                    <label for="vendedorFilter">Vendedor (Opcional)</label>
                    <input type="text" id="vendedorFilter" placeholder="Buscar vendedor...">
                </div>

                <button class="search-btn" onclick="buscarCierres()">Buscar</button>
            </div>
        </div>

        <!-- Pesta√±as para dos sucursales -->
        <div class="tabs-container">
            <button class="tab-button active" onclick="cambiarTab(1)">REFACCIONARIA OVIEDO</button>
            <button class="tab-button" onclick="cambiarTab(2)">REFACCI√ìN PARA OVIEDO</button>
        </div>

        <!-- Tabla Sucursal 1 -->
        <div class="tab-content active" id="tab1">
            <div class="table-section">
                <div class="table-controls">
                    <div class="table-info">
                        <span id="resultCount1">0 resultados</span>
                    </div>
                    <button class="menu-button" onclick="toggleMenu(event, 1)">‚ò∞ Men√∫</button>
                </div>
                <div class="table-wrapper">
                    <table id="cierresTable1">
                        <thead>
                            <tr>
                                <th>CAJA</th>
                                <th>VENDEDOR</th>
                                <th>APERTURA</th>
                                <th>HORA</th>
                                <th>CIERRE</th>
                                <th>HORA</th>
                                <th>MONTO</th>
                            </tr>
                        </thead>
                        <tbody id="tableBody1">
                            <!-- Los datos se cargar√°n aqu√≠ -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Tabla Sucursal 2 -->
        <div class="tab-content" id="tab2">
            <div class="table-section">
                <div class="table-controls">
                    <div class="table-info">
                        <span id="resultCount2">0 resultados</span>
                    </div>
                    <button class="menu-button" onclick="toggleMenu(event, 2)">‚ò∞ Men√∫</button>
                </div>
                <div class="table-wrapper">
                    <table id="cierresTable2">
                        <thead>
                            <tr>
                                <th>CAJA</th>
                                <th>VENDEDOR</th>
                                <th>APERTURA</th>
                                <th>HORA</th>
                                <th>CIERRE</th>
                                <th>HORA</th>
                                <th>MONTO</th>
                            </tr>
                        </thead>
                        <tbody id="tableBody2">
                            <!-- Los datos se cargar√°n aqu√≠ -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Men√∫ contextual -->
    <div class="context-menu" id="contextMenu">
        <div class="context-menu-item" onclick="cerrarCierre()">
            <span>‚ùå</span>
            <span>Cerrar</span>
        </div>
        <div class="context-menu-item" onclick="actualizarDatos()">
            <span>üîÑ</span>
            <span>Actualizar</span>
        </div>
        <div class="context-menu-item divider"></div>
        <div class="context-menu-item" onclick="exportarExcel()">
            <span>üìä</span>
            <span>Exportar listado a Excel</span>
        </div>
        <div class="context-menu-item" onclick="resumenGlobalExcel()">
            <span>üìà</span>
            <span>Resumen Global a Excel</span>
        </div>
        <div class="context-menu-item" onclick="detalladoGlobalExcel()">
            <span>üìã</span>
            <span>Detallado Global a Excel</span>
        </div>
        <div class="context-menu-item divider"></div>
        <div class="context-menu-item" onclick="generarResumen()">
            <span>üñ®Ô∏è</span>
            <span>Generar Resumen de Ventas</span>
        </div>
        <div class="context-menu-item" onclick="verInformacion()">
            <span>‚ÑπÔ∏è</span>
            <span>Ver informaci√≥n del cierre</span>
        </div>
    </div>

    <!-- Modal Resumen -->
    <div id="summaryModal"
        style="display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,.35); z-index:3000; align-items:center; justify-content:center;">
        <div
            style="background:#fff; border-radius:8px; width:600px; max-width:90%; box-shadow:0 6px 20px rgba(0,0,0,.15);">
            <div style="padding:12px 16px; border-bottom:1px solid #eee; font-weight:700;">Resumen de Ventas</div>
            <div style="padding:16px" id="summaryContent"></div>
            <div style="padding:12px 16px; border-top:1px solid #eee; display:flex; gap:8px; justify-content:flex-end;">
                <button class="menu-button" onclick="exportarResumenCSV()">Exportar CSV</button>
                <button class="menu-button" onclick="imprimirResumen()">Imprimir</button>
                <button class="logout-btn" onclick="cerrarResumen()">Cerrar</button>
            </div>
        </div>
    </div>

    <!-- Modal Informaci√≥n del Cierre -->
    <div id="infoModal"
        style="display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,.35); z-index:3000; align-items:center; justify-content:center;">
        <div
            style="background:#fff; border-radius:8px; width:520px; max-width:90%; box-shadow:0 6px 20px rgba(0,0,0,.15);">
            <div style="padding:12px 16px; border-bottom:1px solid #eee; font-weight:700;">Informaci√≥n del cierre</div>
            <div style="padding:16px" id="infoContent"></div>
            <div style="padding:12px 16px; border-top:1px solid #eee; display:flex; gap:8px; justify-content:flex-end;">
                <button class="menu-button" onclick="imprimirInfo()">Imprimir</button>
                <button class="logout-btn" onclick="cerrarInfo()">Cerrar</button>
            </div>
        </div>
    </div>

    <script>
        const sucursales = [
            { id: 1, nombre: 'REFACCIONARIA OVIEDO' },
            { id: 2, nombre: 'REFACCI√ìN PARA OVIEDO' }
        ];

        let currentTab = 1;
        let cierresData = { 1: [], 2: [] };
        let selectedIndex = { 1: -1, 2: -1 };

        function cambiarTab(tabId) {
            currentTab = tabId;
            // Actualizar botones de pesta√±a
            document.querySelectorAll('.tab-button').forEach((btn, idx) => {
                btn.classList.remove('active');
                if (idx + 1 === tabId) btn.classList.add('active');
            });
            // Actualizar contenido
            document.querySelectorAll('.tab-content').forEach((content, idx) => {
                content.classList.remove('active');
                if (idx + 1 === tabId) content.classList.add('active');
            });
        }

        function inicializarSucursales() {
            const select = document.getElementById('sucursalSelect');
            if (!select) { return; }

            select.innerHTML = '';
            sucursales.forEach(s => {
                const opt = document.createElement('option');
                opt.value = s.id;
                opt.textContent = s.nombre;
                select.appendChild(opt);
            });

            let defaultId = sucursales[0].id;

            // Primero, revisar si viene local_id en la URL
            const urlParams = new URLSearchParams(window.location.search);
            const urlLocalId = urlParams.get('local_id');
            if (urlLocalId) {
                const urlId = Number.parseInt(urlLocalId, 10);
                if (!Number.isNaN(urlId) && sucursales.find(s => s.id === urlId)) {
                    defaultId = urlId;
                    select.value = defaultId;
                    return;
                }
            }

            // Si no viene en URL, usar del usuario
            try {
                const user = JSON.parse(localStorage.getItem('user') || '{}');
                if (user && user.local_id) {
                    const match = sucursales.find(s => s.id === Number(user.local_id));
                    if (match) defaultId = match.id;
                } else if (user && user.sucursal) {
                    const byName = sucursales.find(s => s.nombre.toLowerCase() === user.sucursal.toString().toLowerCase());
                    if (byName) defaultId = byName.id;
                }
            } catch (e) {
                console.warn('No se pudo determinar sucursal del usuario:', e.message);
            }

            select.value = defaultId;
        }

        function cambiarSucursal(value) {
            const sucursalId = Number.parseInt(value, 10);
            if (Number.isNaN(sucursalId)) { return; }
            // Cambiar a la pesta√±a correspondiente
            cambiarTab(sucursalId);
        }

        // Funci√≥n para volver al men√∫ de Cajas
        function goBack() {
            console.log('üîô Bot√≥n Volver clickeado - Navegando a /cajas');
            console.log('üìç URL actual:', window.location.href);
            window.location.href = '/cajas';
            console.log('‚úÖ Navegaci√≥n iniciada');
        }

        // Ir al submen√∫ de Cajas
        function goToCajas() {
            console.log('üè† Breadcrumb Cajas clickeado - Navegando a /cajas');
            window.location.href = '/cajas';
        }

        // Funci√≥n para cerrar sesi√≥n
        function logout() {
            if (confirm('¬øDeseas cerrar sesi√≥n?')) {
                localStorage.removeItem('token');
                window.location.href = '/login.html';
            }
        }

        // Funci√≥n para toggle del men√∫
        function toggleMenu(event, tabId) {
            event.stopPropagation();
            const menu = document.getElementById('contextMenu');
            menu.classList.toggle('show');
            menu.dataset.tabId = tabId;

            if (menu.classList.contains('show')) {
                const rect = event.target.getBoundingClientRect();
                menu.style.top = (rect.bottom + 5) + 'px';
                menu.style.left = (rect.right - 220) + 'px';
            }
        }

        // Cerrar men√∫ al hacer clic fuera
        document.addEventListener('click', function (e) {
            const menu = document.getElementById('contextMenu');
            const menuButton = document.querySelector('.menu-button');
            if (menu && !menu.contains(e.target) && !menuButton.contains(e.target)) {
                menu.classList.remove('show');
            }
        });

        // Funciones del men√∫ (funcionales)
        function cerrarCierre() {
            const menu = document.getElementById('contextMenu');
            const tabId = parseInt(menu.dataset.tabId || currentTab);
            menu.classList.remove('show');
            if (selectedIndex[tabId] < 0 || !cierresData[tabId][selectedIndex[tabId]]) {
                alert('Selecciona un cierre en la tabla para continuar.');
                return;
            }
            const ci = cierresData[tabId][selectedIndex[tabId]];
            const url = `/static/cierre_caja_nuevo.html?caja=${encodeURIComponent(ci.caja)}&vendedor=${encodeURIComponent(ci.vendedor)}&local_id=${tabId}`;
            window.location.href = url;
        }

        function actualizarDatos() {
            buscarCierres();
            document.getElementById('contextMenu').classList.remove('show');
        }

        function exportarExcel() {
            const tabId = parseInt(document.getElementById('contextMenu').dataset.tabId || currentTab);
            const tabla = document.getElementById(`cierresTable${tabId}`);
            exportarTableToExcel(tabla, `Cierres_Caja_Sucursal_${tabId}`);
            document.getElementById('contextMenu').classList.remove('show');
        }

        function resumenGlobalExcel() {
            const tabId = parseInt(document.getElementById('contextMenu').dataset.tabId || currentTab);
            if (!cierresData[tabId] || cierresData[tabId].length === 0) { alert('No hay datos para resumir'); return; }
            const setCajas = new Set(cierresData[tabId].map(c => c.caja));
            const setVendedores = new Set(cierresData[tabId].map(c => c.vendedor));
            const fechasApertura = cierresData[tabId].map(c => c.apertura).filter(Boolean);
            const fechasCierre = cierresData[tabId].map(c => c.cierre).filter(Boolean);
            const rangoInicio = fechasApertura.sort((a, b) => a.localeCompare(b))[0] || '';
            const rangoFin = fechasCierre.sort((a, b) => b.localeCompare(a))[0] || '';

            // Conteo por vendedor
            const conteoVendedor = {};
            cierresData[tabId].forEach(c => { conteoVendedor[c.vendedor] = (conteoVendedor[c.vendedor] || 0) + 1; });

            const lineas = [];
            lineas.push(['Indicador', 'Valor', 'Notas'].join(','));
            lineas.push(['Total cierres', cierresData[tabId].length, ''].join(','));
            lineas.push(['Cajas √∫nicas', setCajas.size, ''].join(','));
            lineas.push(['Vendedores √∫nicos', setVendedores.size, ''].join(','));
            lineas.push(['Rango', `${rangoInicio} - ${rangoFin}`, ''].join(','));
            lineas.push('');
            lineas.push(['Cierres por vendedor', 'Cantidad'].join(','));
            Object.entries(conteoVendedor).forEach(([v, c]) => lineas.push([v, c].join(',')));

            downloadCSV(lineas.join('\n'), `Resumen_Global_Cierres_Sucursal_${tabId}`);
            document.getElementById('contextMenu').classList.remove('show');
        }

        function detalladoGlobalExcel() {
            const tabId = parseInt(document.getElementById('contextMenu').dataset.tabId || currentTab);
            if (!cierresData[tabId] || cierresData[tabId].length === 0) { alert('No hay datos para exportar'); return; }
            const encabezado = ['CAJA', 'VENDEDOR', 'APERTURA', 'HORA_APERTURA', 'CIERRE', 'HORA_CIERRE'];
            const lineas = [encabezado.join(',')];
            cierresData[tabId].forEach(c => lineas.push([c.caja, c.vendedor, c.apertura, c.hora_apertura, c.cierre, c.hora_cierre].join(',')));
            downloadCSV(lineas.join('\n'), `Detallado_Global_Cierres_Sucursal_${tabId}`);
            document.getElementById('contextMenu').classList.remove('show');
        }

        async function generarResumen() {
            const fechaInicio = document.getElementById('fechaInicio').value;
            const fechaFin = document.getElementById('fechaFin').value;
            const token = localStorage.getItem('token');
            try {
                const res = await fetch(`/api/v1/reportes/cierres-caja/estadisticas?fecha_inicio=${fechaInicio}&fecha_fin=${fechaFin}`, {
                    headers: { 'Content-Type': 'application/json', ...(token ? { Authorization: `Bearer ${token}` } : {}) }
                });
                if (!res.ok) { throw new Error('Error al obtener estad√≠sticas'); }
                const stats = await res.json();
                const mp = stats.por_metodo_pago || {};
                const pv = stats.por_vendedor || {};
                const html = `
                    <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px;">
                        <div><strong>Total ventas:</strong> ${stats.total_ventas ?? 0}</div>
                        <div><strong>Total ingresos:</strong> ${Number(stats.total_ingresos || 0).toFixed(2)}</div>
                        <div><strong>Total descuentos:</strong> ${Number(stats.total_descuentos || 0).toFixed(2)}</div>
                        <div><strong>Promedio por venta:</strong> ${Number(stats.promedio_venta || 0).toFixed(2)}</div>
                    </div>
                    <h4 style="margin-top:16px">Por m√©todo de pago</h4>
                    <table style="width:100%; border-collapse:collapse; font-size:13px;">
                        <thead><tr style="background:#f3f3f3"><th style="text-align:left; padding:6px 8px">M√©todo</th><th style="text-align:right; padding:6px 8px">Conteo</th><th style="text-align:right; padding:6px 8px">Total</th></tr></thead>
                        <tbody>
                            ${Object.entries(mp).map(([k, v]) => `<tr><td style='padding:6px 8px'>${k}</td><td style='padding:6px 8px; text-align:right'>${v.conteo}</td><td style='padding:6px 8px; text-align:right'>${Number(v.total || 0).toFixed(2)}</td></tr>`).join('')}
                        </tbody>
                    </table>
                    <h4 style="margin-top:16px">Por vendedor</h4>
                    <table style="width:100%; border-collapse:collapse; font-size:13px;">
                        <thead><tr style="background:#f3f3f3"><th style="text-align:left; padding:6px 8px">Vendedor</th><th style="text-align:right; padding:6px 8px">Conteo</th><th style="text-align:right; padding:6px 8px">Total</th></tr></thead>
                        <tbody>
                            ${Object.entries(pv).map(([k, v]) => `<tr><td style='padding:6px 8px'>${k}</td><td style='padding:6px 8px; text-align:right'>${v.conteo}</td><td style='padding:6px 8px; text-align:right'>${Number(v.total || 0).toFixed(2)}</td></tr>`).join('')}
                        </tbody>
                    </table>`;
                document.getElementById('summaryContent').innerHTML = html;
                document.getElementById('summaryModal').style.display = 'flex';
            } catch (err) {
                alert(err.message);
            }
            document.getElementById('contextMenu').classList.remove('show');
        }

        function exportarResumenCSV() {
            const sc = document.getElementById('summaryContent');
            const tablas = Array.from(sc.querySelectorAll('table'));
            const lineas = [];
            // Encabezados de res√∫menes principales
            const principales = Array.from(sc.querySelectorAll('div > div'));
            lineas.push(['Resumen', 'Valor'].join(','));
            principales.forEach(el => {
                const t = el.innerText.split(':');
                if (t.length >= 2) { lineas.push([t[0].trim(), t.slice(1).join(':').trim()].join(',')); }
            });
            lineas.push('');
            // Tablas
            tablas.forEach((tbl, idx) => {
                const h = tbl.previousElementSibling?.innerText || `Tabla ${idx + 1}`;
                lineas.push([h, ''].join(','));
                const rows = Array.from(tbl.querySelectorAll('tr'));
                rows.forEach((row, i) => {
                    const cols = Array.from(row.querySelectorAll('th, td')).map(c => c.innerText);
                    lineas.push(cols.join(','));
                });
                lineas.push('');
            });
            downloadCSV(lineas.join('\n'), 'Resumen_Ventas');
        }
        function cerrarResumen() { document.getElementById('summaryModal').style.display = 'none'; }

        function imprimirResumen() {
            const content = document.getElementById('summaryContent').innerHTML;
            const w = window.open('', '_blank');
            w.document.write(`<html><head><title>Resumen de Ventas</title></head><body>${content}</body></html>`);
            w.document.close();
            w.focus();
            w.print();
            w.close();
        }

        function verInformacion() {
            const menu = document.getElementById('contextMenu');
            const tabId = parseInt(menu.dataset.tabId || currentTab);
            menu.classList.remove('show');
            if (selectedIndex[tabId] < 0 || !cierresData[tabId][selectedIndex[tabId]]) {
                alert('Selecciona un cierre en la tabla para ver detalles.');
                return;
            }
            const c = cierresData[tabId][selectedIndex[tabId]];
            const html = `
                <div style="display:grid; grid-template-columns: 160px 1fr; row-gap:8px; column-gap:12px;">
                    <div><strong>Caja:</strong></div><div>${c.caja}</div>
                    <div><strong>Vendedor:</strong></div><div>${c.vendedor}</div>
                    <div><strong>Apertura:</strong></div><div>${c.apertura} ${c.hora_apertura}</div>
                    <div><strong>Cierre:</strong></div><div>${c.cierre} ${c.hora_cierre}</div>
                </div>`;
            document.getElementById('infoContent').innerHTML = html;
            document.getElementById('infoModal').style.display = 'flex';
        }
        function cerrarInfo() { document.getElementById('infoModal').style.display = 'none'; }

        function imprimirInfo() {
            const content = document.getElementById('infoContent').innerHTML;
            const w = window.open('', '_blank');
            w.document.write(`<html><head><title>Informaci√≥n del Cierre</title></head><body>${content}</body></html>`);
            w.document.close();
            w.focus();
            w.print();
            w.close();
        }

        // Funci√≥n para exportar a Excel
        function exportarTableToExcel(table, filename) {
            const csv = [];
            const rows = table.querySelectorAll('tr');

            rows.forEach(row => {
                const cols = row.querySelectorAll('td, th');
                const csvRow = [];
                cols.forEach(col => {
                    csvRow.push(col.innerText);
                });
                csv.push(csvRow.join(','));
            });

            downloadCSV(csv.join('\n'), filename);
        }

        function downloadCSV(csv, filename) {
            const csvFile = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(csvFile);

            link.setAttribute('href', url);
            link.setAttribute('download', filename + '.csv');
            link.style.visibility = 'hidden';

            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // Funci√≥n para buscar cierres de caja
        function buscarCierres() {
            const caja = document.getElementById('cajaFilter').value;
            const fechaInicio = document.getElementById('fechaInicio').value;
            const fechaFin = document.getElementById('fechaFin').value;
            const vendedor = document.getElementById('vendedorFilter').value;

            // Validaci√≥n b√°sica
            if (!fechaInicio || !fechaFin) {
                alert('Por favor selecciona un rango de fechas');
                return;
            }

            if (new Date(fechaInicio) > new Date(fechaFin)) {
                alert('La fecha de inicio no puede ser mayor a la fecha de fin');
                return;
            }

            // Cargar datos para ambas sucursales
            loadCierres(caja, fechaInicio, fechaFin, vendedor, 1);
            loadCierres(caja, fechaInicio, fechaFin, vendedor, 2);
        }

        // Funci√≥n para cargar los cierres desde la API
        function loadCierres(caja, fechaInicio, fechaFin, vendedor, sucursalId) {
            const tableBody = document.getElementById(`tableBody${sucursalId}`);
            if (!cierresData[sucursalId]) cierresData[sucursalId] = [];
            if (!selectedIndex[sucursalId]) selectedIndex[sucursalId] = -1;

            cierresData[sucursalId] = [];
            selectedIndex[sucursalId] = -1;
            tableBody.innerHTML = `
                <tr>
                    <td colspan="7" style="text-align: center; padding: 40px; color: #999;">
                        Cargando datos...
                    </td>
                </tr>
            `;

            // Construir URL con par√°metros
            let url = `/api/v1/reportes/cierres-caja?fecha_inicio=${fechaInicio}&fecha_fin=${fechaFin}&local_id=${sucursalId}`;

            if (caja) {
                url += `&caja=${encodeURIComponent(caja)}`;
            }

            if (vendedor) {
                url += `&vendedor=${encodeURIComponent(vendedor)}`;
            }

            const token = localStorage.getItem('token');

            fetch(url, {
                method: 'GET',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                }
            })
                .then(response => {
                    if (!response.ok) {
                        if (response.status === 401) {
                            window.location.href = '/login.html';
                        }
                        throw new Error(`Error: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    renderCierres(data.cierres, data.total, sucursalId);
                })
                .catch(error => {
                    console.error('Error:', error);
                    tableBody.innerHTML = `
                    <tr>
                        <td colspan="7" style="text-align: center; padding: 40px; color: #e74c3c;">
                            Error al cargar los datos: ${error.message}
                        </td>
                    </tr>
                `;
                });
        }

        // Funci√≥n para renderizar los cierres en la tabla
        function renderCierres(cierres, total, sucursalId) {
            const tableBody = document.getElementById(`tableBody${sucursalId}`);

            if (!cierres || cierres.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="7" style="text-align: center; padding: 40px; color: #999;">
                            No hay cierres de caja en este rango de fechas
                        </td>
                    </tr>
                `;
                document.getElementById(`resultCount${sucursalId}`).textContent = '0 resultados';
                return;
            }

            cierresData[sucursalId] = cierres;
            tableBody.innerHTML = cierres.map((cierre, idx) => `
                <tr data-index="${idx}" onclick="seleccionarFila(${idx}, ${sucursalId})">
                    <td>${cierre.caja}</td>
                    <td>${cierre.vendedor}</td>
                    <td>${cierre.apertura}</td>
                    <td>${cierre.hora_apertura}</td>
                    <td>${cierre.cierre}</td>
                    <td>${cierre.hora_cierre}</td>
                    <td style="text-align: right; font-weight: 600;">$${parseFloat(cierre.total_cierre || 0).toLocaleString('es-MX', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
                </tr>
            `).join('');

            document.getElementById(`resultCount${sucursalId}`).textContent = `${cierres.length} resultados`;
        }

        function seleccionarFila(i, tabId) {
            selectedIndex[tabId] = i;
            const tbody = document.getElementById(`tableBody${tabId}`);
            Array.from(tbody.querySelectorAll('tr')).forEach((tr, idx) => {
                if (idx === i) tr.classList.add('selected'); else tr.classList.remove('selected');
            });
        }

        // Inicializaci√≥n al cargar la p√°gina
        document.addEventListener('DOMContentLoaded', function () {
            // Cargar informaci√≥n del usuario
            const token = localStorage.getItem('token');
            if (!token) {
                // En modo demo, permitir acceso sin token
                console.log('Sin token - modo demo');
            }

            // Mostrar sucursal
            const sucursalNombre = localStorage.getItem('sucursal_nombre');
            if (sucursalNombre) {
                document.getElementById('sucursalBadge').textContent = sucursalNombre;
            }

            inicializarSucursales();

            // Establecer fechas por defecto (hoy)
            const hoy = new Date().toISOString().split('T')[0];
            document.getElementById('fechaFin').value = hoy;

            // Fecha hace 30 d√≠as
            const hace30Dias = new Date();
            hace30Dias.setDate(hace30Dias.getDate() - 30);
            document.getElementById('fechaInicio').value = hace30Dias.toISOString().split('T')[0];

            // Mostrar placeholder inicial
            document.getElementById('tableBody1').innerHTML = `
                <tr>
                    <td colspan="7" style="text-align: center; padding: 40px; color: #999;">
                        Haz clic en "Buscar" para ver los cierres de caja
                    </td>
                </tr>
            `;
            document.getElementById('tableBody2').innerHTML = `
                <tr>
                    <td colspan="7" style="text-align: center; padding: 40px; color: #999;">
                        Haz clic en "Buscar" para ver los cierres de caja
                    </td>
                </tr>
            `;

            // Cargar informaci√≥n del usuario si est√° disponible
            const userData = localStorage.getItem('user');
            if (userData) {
                try {
                    const user = JSON.parse(userData);
                    document.getElementById('userDisplay').textContent = `Usuario: ${user.username || 'Admin'}`;
                } catch (e) {
                    console.error('Error al parsear datos de usuario:', e);
                }
            }
        });

        // Enter para buscar en los inputs de filtro
        document.addEventListener('DOMContentLoaded', function () {
            document.getElementById('cajaFilter').addEventListener('keypress', function (e) {
                if (e.key === 'Enter') buscarCierres();
            });
            document.getElementById('fechaInicio').addEventListener('keypress', function (e) {
                if (e.key === 'Enter') buscarCierres();
            });
            document.getElementById('fechaFin').addEventListener('keypress', function (e) {
                if (e.key === 'Enter') buscarCierres();
            });
            document.getElementById('vendedorFilter').addEventListener('keypress', function (e) {
                if (e.key === 'Enter') buscarCierres();
            });
        });
    </script>
</body>

</html>